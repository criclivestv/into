<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live DASH Player • Shaka + Share/Embed</title>

<!-- Shaka Player UI CSS -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css">

<style>
:root {
    --accent: #1a73e8;
    --bg: #000;
    --panel-bg: rgba(20,20,20,0.9);
    --text: #fff;
}
body, html {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100%;
    width: 100%;
}
.wrap {
    max-width: 1200px;
    margin: 12px auto;
    padding: 12px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
}
h1 {
    font-size: 20px;
    margin: 0 0 6px 0;
}
.panel {
    background: var(--panel-bg);
    padding: 12px;
    border-radius: 8px;
}
.controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
input[type="text"], input[type="url"] {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #333;
    background: #111;
    color: var(--text);
    min-width: 260px;
}
button {
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
}
button.secondary { background: #333; }

.player-wrap {
    position: relative;
    background: #000;
    border-radius: 6px;
    overflow: hidden;
}

#player-container {
    width: 100%;
    aspect-ratio: 16/9;
    position: relative;
    background: #000;
}

video.shaka-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
    display: block;
}

.shaka-controls-container {
    z-index: 9999 !important;
    background: transparent !important;
}

/* Overlays: logo & watermark */
.overlay-logo {
    position: absolute;
    z-index: 50;
    pointer-events: none;
    display: none;
}
.overlay-text {
    position: absolute;
    z-index: 49;
    pointer-events: none;
    color: rgba(255,255,255,0.65);
    font-weight: 600;
    display: none;
}

/* Share/Embed section styling */
textarea { width: 100%; min-height: 60px; padding: 6px; border-radius: 6px; background: #111; border: 1px solid #333; color: var(--text); }

@media(min-width: 900px){
    .wrap { grid-template-columns: 420px 1fr; }
}
</style>
</head>
<body>
<div class="wrap">
    <!-- Control Panel -->
    <div class="panel">
        <h1>Live DASH Player • Share & Embed</h1>

        <div class="small">Paste DASH/MPD URL:</div>
        <div class="controls">
            <input id="input-url" type="url" placeholder="https://example.com/stream.mpd">
            <button id="load-btn">Load</button>
            <button id="use-sample" class="secondary">Use Sample</button>
        </div>

        <hr style="border-color:#222;margin:10px 0">

        <!-- Logo / Watermark -->
        <div>
            <div class="small">Logo / Watermark Settings</div>
            <div class="controls">
                <input id="logo-url" type="url" placeholder="Logo URL (optional)">
                <select id="logo-pos">
                    <option value="top-left">Top-left</option>
                    <option value="top-right">Top-right</option>
                    <option value="bottom-left">Bottom-left</option>
                    <option value="bottom-right">Bottom-right</option>
                    <option value="center">Center</option>
                </select>
                <input id="logo-size" type="text" placeholder="Width px" style="width:100px">
                <label>Opacity</label>
                <input id="logo-opacity" type="range" min="0" max="100" value="85">
                <span id="logo-opacity-val">85%</span>
                <button id="apply-logo" class="secondary">Apply</button>
            </div>

            <div class="controls" style="margin-top:6px">
                <input id="wm-text" type="text" placeholder="Text watermark">
                <button id="apply-wm" class="secondary">Apply Text</button>
                <button id="clear-wm" class="secondary">Clear</button>
            </div>
        </div>

        <hr style="border-color:#222;margin:10px 0">

        <!-- Share / Embed -->
        <div>
            <div class="small">Share / Embed</div>
            <div class="controls">
                <button id="gen-link">Generate Share Link</button>
                <button id="copy-link" class="secondary">Copy Link</button>
                <button id="gen-embed" class="secondary">Get Embed Code</button>
            </div>
            <textarea id="output" placeholder="Share link or embed code will appear here"></textarea>
        </div>
    </div>

    <!-- Video Player Preview -->
    <div class="player-wrap panel">
        <div id="player-container">
            <video id="video" autoplay playsinline class="shaka-video"></video>
            <div class="shaka-controls-container"></div>

            <!-- overlays -->
            <img id="overlayLogo" class="overlay-logo" alt="logo">
            <div id="overlayText" class="overlay-text"></div>
        </div>
        <div style="height:6px"></div>
        <div class="small">Tip: Use ?url=YOUR_MPD&amp;logo=LOGO_URL in query to pre-load</div>
    </div>
</div>

<!-- Shaka JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js"></script><script>
(async function(){
  // DOM references
  const video = document.getElementById('video');
  const container = document.getElementById('player-container');
  const inputUrl = document.getElementById('input-url');
  const loadBtn = document.getElementById('load-btn');
  const useSample = document.getElementById('use-sample');
  const genLink = document.getElementById('gen-link');
  const copyLink = document.getElementById('copy-link');
  const genEmbed = document.getElementById('gen-embed');
  const output = document.getElementById('output');

  const logoUrlInp = document.getElementById('logo-url');
  const logoPos = document.getElementById('logo-pos');
  const logoSize = document.getElementById('logo-size');
  const logoOpacity = document.getElementById('logo-opacity');
  const logoOpacityVal = document.getElementById('logo-opacity-val');
  const applyLogo = document.getElementById('apply-logo');

  const wmText = document.getElementById('wm-text');
  const applyWm = document.getElementById('apply-wm');
  const clearWm = document.getElementById('clear-wm');

  const overlayLogo = document.getElementById('overlayLogo');
  const overlayText = document.getElementById('overlayText');

  // Initialize Shaka Player
  const player = new shaka.Player(video);
  player.addEventListener('error', e => console.error('Shaka error', e.detail || e));

  // Attach UI overlay
  const ui = new shaka.ui.Overlay(player, container, video);
  ui.configure({
    controlPanelElements: [
      'play_pause', 'mute', 'volume', 'spacer',
      'settings', 'quality', 'playback_rate', 'picture_in_picture', 'fullscreen'
    ],
    settingsMenuElements: [
      'quality','playback_rate'
    ]
  });

  player.configure({ abr: { enabled: true } });

  // Helper: set logo/watermark position & opacity
  function placeOverlay(element, pos, width, opacity) {
    element.style.display = width ? 'block' : (element.src ? 'block' : 'none');
    element.style.opacity = opacity/100 || 0.85;
    if(width) element.style.width = width + 'px';
    element.style.height = 'auto';
    element.style.pointerEvents = 'none';

    // Reset positions
    element.style.top = '';
    element.style.left = '';
    element.style.right = '';
    element.style.bottom = '';
    element.style.transform = '';

    switch(pos) {
      case 'top-left': element.style.top='10px'; element.style.left='10px'; break;
      case 'top-right': element.style.top='10px'; element.style.right='10px'; break;
      case 'bottom-left': element.style.bottom='10px'; element.style.left='10px'; break;
      case 'bottom-right': element.style.bottom='10px'; element.style.right='10px'; break;
      case 'center': element.style.top='50%'; element.style.left='50%'; element.style.transform='translate(-50%,-50%)'; break;
      default: element.style.top='10px'; element.style.left='10px';
    }
  }

  function applyLogoSettings(){
    const url = logoUrlInp.value.trim();
    const pos = logoPos.value;
    const size = parseInt(logoSize.value) || 120;
    const opacity = Number(logoOpacity.value || 85);

    if(url){
      overlayLogo.src = url;
      overlayLogo.style.display = 'block';
    } else if(!overlayLogo.src){
      overlayLogo.style.display = 'none';
    }

    placeOverlay(overlayLogo, pos, size, opacity);
  }

  logoOpacity.addEventListener('input', ()=> logoOpacityVal.textContent = logoOpacity.value + '%');
  applyLogo.addEventListener('click', ()=>{
    applyLogoSettings();
    updateOutputForShare();
  });

  applyWm.addEventListener('click', ()=>{
    const text = wmText.value.trim();
    if(text){
      overlayText.textContent = text;
      overlayText.style.display = 'block';
      overlayText.style.fontSize = '18px';
      overlayText.style.opacity = '0.75';
      placeOverlay(overlayText, logoPos.value, parseInt(logoSize.value)||120, Number(logoOpacity.value||85));
      updateOutputForShare();
    }
  });

  clearWm.addEventListener('click', ()=>{
    overlayText.textContent = '';
    overlayText.style.display = 'none';
    updateOutputForShare();
  });

  // Load stream
  async function loadStream(manifestUri){
    try{
      await player.load(manifestUri);
      console.log('Loaded', manifestUri);
      output.value = '';
    } catch(err){
      console.error('Load failed:', err);
      alert('Error loading stream. Check console.');
    }
  }

  loadBtn.addEventListener('click', ()=> {
    const url = inputUrl.value.trim();
    if(!url) return alert('Please paste a DASH/MPD URL.');
    loadStream(url);
  });

  useSample.addEventListener('click', ()=> {
    const sample = 'https://v4-kun-v13-cdn-02.live.cdn.cgates.lt/live/dash/560502/web.mpd';
    inputUrl.value = sample;
    loadStream(sample);
  });

  // Query params support
  const params = new URLSearchParams(location.search);
  if(params.get('url')) { inputUrl.value = params.get('url'); loadStream(params.get('url')); }
  if(params.get('logo')) { logoUrlInp.value = params.get('logo'); if(params.get('logoPos')) logoPos.value=params.get('logoPos'); if(params.get('logoSize')) logoSize.value=params.get('logoSize'); applyLogoSettings(); }
  if(params.get('wmtext')) { wmText.value=decodeURIComponent(params.get('wmtext')); overlayText.textContent = wmText.value; overlayText.style.display='block'; }

  // Share / Embed
  function buildShareUrl(){
    const base = location.origin + location.pathname;
    const url = inputUrl.value.trim();
    if(!url) return '';
    const u = new URL(base);
    u.searchParams.set('url', url);
    if(logoUrlInp.value.trim()) u.searchParams.set('logo', logoUrlInp.value.trim());
    if(logoPos.value) u.searchParams.set('logoPos', logoPos.value);
    if(logoSize.value.trim()) u.searchParams.set('logoSize', logoSize.value.trim());
    if(wmText.value.trim()) u.searchParams.set('wmtext', encodeURIComponent(wmText.value.trim()));
    return u.toString();
  }

  genLink.addEventListener('click', ()=> output.value = buildShareUrl());
  copyLink.addEventListener('click', async ()=>{
    const txt = output.value.trim();
    if(!txt) return alert('Nothing to copy.');
    try{ await navigator.clipboard.writeText(txt); alert('Copied to clipboard'); }catch(e){ prompt('Copy manually:', txt); }
  });
  genEmbed.addEventListener('click', ()=>{
    const share = buildShareUrl();
    if(!share) return alert('Load a stream first.');
    const iframe = `<iframe src="${share}" width="800" height="450" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
    output.value = iframe;
  });

  function updateOutputForShare(){
    if(output.value && output.value.includes(location.origin + location.pathname)){
      output.value = buildShareUrl();
    }
  }

})();
</script>
</body>
</html>
